From b7292ca97931398a32d2fa38b4f5fc63bd454fc7 Mon Sep 17 00:00:00 2001
From: Matteo Bertozzi <mbertozzi@apache.org>
Date: Thu, 20 Feb 2014 10:08:54 +0000
Subject: [PATCH 34/86] HBASE-6642 enable_all,disable_all,drop_all can call 'list' command with regex directly

Reason: Bug
Author: Matteo Bertozzi
Ref: CDH-13457

git-svn-id: https://svn.apache.org/repos/asf/hbase/trunk@1570128 13f79535-47bb-0310-9956-ffa450edef68
---
 hbase-shell/src/main/ruby/hbase/admin.rb           |   10 ++++++----
 .../src/main/ruby/hbase/replication_admin.rb       |    6 ++++--
 .../src/main/ruby/shell/commands/disable_all.rb    |    3 +--
 .../src/main/ruby/shell/commands/drop_all.rb       |    3 +--
 .../src/main/ruby/shell/commands/enable_all.rb     |    3 +--
 .../src/main/ruby/shell/commands/list_namespace.rb |    3 +--
 .../ruby/shell/commands/list_replicated_tables.rb  |    4 +---
 .../src/main/ruby/shell/commands/list_snapshots.rb |    3 +--
 8 files changed, 16 insertions(+), 19 deletions(-)

diff --git a/hbase-shell/src/main/ruby/hbase/admin.rb b/hbase-shell/src/main/ruby/hbase/admin.rb
index 8ab2ef4..1fbd475 100644
--- a/hbase-shell/src/main/ruby/hbase/admin.rb
+++ b/hbase-shell/src/main/ruby/hbase/admin.rb
@@ -710,8 +710,8 @@ module Hbase
 
     #----------------------------------------------------------------------------------------------
     # Returns a list of snapshots
-    def list_snapshot
-      @admin.listSnapshots
+    def list_snapshot(regex = ".*")
+      @admin.listSnapshots(regex).to_a
     end
 
     # Apply config specific to a table/column to its descriptor
@@ -737,8 +737,10 @@ module Hbase
 
     #----------------------------------------------------------------------------------------------
     # Returns a list of namespaces in hbase
-    def list_namespace
-      @admin.listNamespaceDescriptors.map { |ns| ns.getName }
+    def list_namespace(regex = ".*")
+      pattern = java.util.regex.Pattern.compile(regex)
+      list = @admin.listNamespaceDescriptors.map { |ns| ns.getName }
+      list.select {|s| pattern.match(s) }
     end
 
     #----------------------------------------------------------------------------------------------
diff --git a/hbase-shell/src/main/ruby/hbase/replication_admin.rb b/hbase-shell/src/main/ruby/hbase/replication_admin.rb
index baa6aea..7f50115 100644
--- a/hbase-shell/src/main/ruby/hbase/replication_admin.rb
+++ b/hbase-shell/src/main/ruby/hbase/replication_admin.rb
@@ -45,8 +45,10 @@ module Hbase
 
     #---------------------------------------------------------------------------------------------
     # Show replcated tables/column families, and their ReplicationType
-    def list_replicated_tables
-       @replication_admin.listReplicated()
+    def list_replicated_tables(regex = ".*")
+      pattern = java.util.regex.Pattern.compile(regex)
+      list = @replication_admin.listReplicated()
+      list.select {|s| pattern.match(s.get(org.apache.hadoop.hbase.client.replication.ReplicationAdmin::TNAME))}
     end
 
     #----------------------------------------------------------------------------------------------
diff --git a/hbase-shell/src/main/ruby/shell/commands/disable_all.rb b/hbase-shell/src/main/ruby/shell/commands/disable_all.rb
index 0e7c30e..27c7a0b 100644
--- a/hbase-shell/src/main/ruby/shell/commands/disable_all.rb
+++ b/hbase-shell/src/main/ruby/shell/commands/disable_all.rb
@@ -29,8 +29,7 @@ EOF
       end
 
       def command(regex)
-        regex = /^#{regex}$/ unless regex.is_a?(Regexp)
-        list = admin.list.grep(regex)
+        list = admin.list(regex)
         count = list.size
         list.each do |table|
           formatter.row([ table ])
diff --git a/hbase-shell/src/main/ruby/shell/commands/drop_all.rb b/hbase-shell/src/main/ruby/shell/commands/drop_all.rb
index e482d6b..a20d578 100644
--- a/hbase-shell/src/main/ruby/shell/commands/drop_all.rb
+++ b/hbase-shell/src/main/ruby/shell/commands/drop_all.rb
@@ -29,8 +29,7 @@ EOF
       end
 
       def command(regex)
-        regex = /^#{regex}$/ unless regex.is_a?(Regexp)
-        list = admin.list.grep(regex)
+        list = admin.list(regex)
         count = list.size
         list.each do |table|
           formatter.row([ table ])
diff --git a/hbase-shell/src/main/ruby/shell/commands/enable_all.rb b/hbase-shell/src/main/ruby/shell/commands/enable_all.rb
index fc0f081..d2811fd 100644
--- a/hbase-shell/src/main/ruby/shell/commands/enable_all.rb
+++ b/hbase-shell/src/main/ruby/shell/commands/enable_all.rb
@@ -29,8 +29,7 @@ EOF
       end
 
       def command(regex)
-        regex = /^#{regex}$/ unless regex.is_a?(Regexp)
-        list = admin.list.grep(regex)
+        list = admin.list(regex)
         count = list.size
         list.each do |table|
           formatter.row([ table ])
diff --git a/hbase-shell/src/main/ruby/shell/commands/list_namespace.rb b/hbase-shell/src/main/ruby/shell/commands/list_namespace.rb
index 0b577fe..5d25604 100644
--- a/hbase-shell/src/main/ruby/shell/commands/list_namespace.rb
+++ b/hbase-shell/src/main/ruby/shell/commands/list_namespace.rb
@@ -34,8 +34,7 @@ EOF
         now = Time.now
         formatter.header([ "NAMESPACE" ])
 
-        regex = /#{regex}/ unless regex.is_a?(Regexp)
-        list = admin.list_namespace.grep(regex)
+        list = admin.list_namespace(regex)
         list.each do |table|
           formatter.row([ table ])
         end
diff --git a/hbase-shell/src/main/ruby/shell/commands/list_replicated_tables.rb b/hbase-shell/src/main/ruby/shell/commands/list_replicated_tables.rb
index b1494b8..0db1d83 100644
--- a/hbase-shell/src/main/ruby/shell/commands/list_replicated_tables.rb
+++ b/hbase-shell/src/main/ruby/shell/commands/list_replicated_tables.rb
@@ -34,9 +34,7 @@ EOF
         now = Time.now
 
         formatter.header([ "TABLE:COLUMNFAMILY", "ReplicationType" ], [ 32 ])
-        list = replication_admin.list_replicated_tables
-        regex = /#{regex}/ unless regex.is_a?(Regexp)
-        list = list.select {|s| regex.match(s.get(org.apache.hadoop.hbase.client.replication.ReplicationAdmin::TNAME))}
+        list = replication_admin.list_replicated_tables(regex)
         list.each do |e|
           if e.get(org.apache.hadoop.hbase.client.replication.ReplicationAdmin::REPLICATIONTYPE) == org.apache.hadoop.hbase.client.replication.ReplicationAdmin::REPLICATIONGLOBAL
              replicateType = "GLOBAL"
diff --git a/hbase-shell/src/main/ruby/shell/commands/list_snapshots.rb b/hbase-shell/src/main/ruby/shell/commands/list_snapshots.rb
index 9513518..4e68802 100644
--- a/hbase-shell/src/main/ruby/shell/commands/list_snapshots.rb
+++ b/hbase-shell/src/main/ruby/shell/commands/list_snapshots.rb
@@ -37,8 +37,7 @@ EOF
         now = Time.now
         formatter.header([ "SNAPSHOT", "TABLE + CREATION TIME"])
 
-        regex = /#{regex}/ unless regex.is_a?(Regexp)
-        list = admin.list_snapshot.select {|s| regex.match(s.getName)}
+        list = admin.list_snapshot(regex)
         list.each do |snapshot|
           creation_time = Time.at(snapshot.getCreationTime() / 1000).to_s
           formatter.row([ snapshot.getName, snapshot.getTable + " (" + creation_time + ")" ])
-- 
1.7.0.4

